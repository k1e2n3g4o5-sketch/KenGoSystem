<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>KenGo式：転生ステータス鑑定（王道RPG）</title>
<meta name="theme-color" content="#0b1328">
<style>
/* ============ Royal Classic (middle-of-the-road) ============ */
:root{
  --bg1:#0b1328; --bg2:#101b38;
  --card:#0f1732f0; --ink:#e9eefc; --mut:#aeb9e8;
  --edge:#9fb2ff; --shadow:#0008;
  --gold1:#f2d37a; --gold2:#d7b64b; --gold3:#7a6320;
  --hp:#e05a63; --mp:#64a7ff; --sp:#1ec8c6; --bar:#172451;
  --ok:#8bf0a6; --warn:#ffd06a; --mutbar:#96a5d8;
}
*{box-sizing:border-box}
html,body{margin:0;height:100%;background:linear-gradient(160deg,var(--bg2),var(--bg1));color:var(--ink);
  font-family: "Hiragino Sans","Noto Sans JP",Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial;}
.wrap{max-width:980px;margin:0 auto;padding:20px}

/* Card (控えめなRPGウィンドウ) */
.card{
  background:var(--card); border:2px solid var(--edge); border-radius:12px;
  box-shadow:0 12px 28px var(--shadow), inset 0 0 0 2px #24346c; padding:16px;
}
h1{margin:0;font-size:22px;font-weight:800;letter-spacing:.3px}
.sub{color:var(--mut);font-size:13px;margin-top:4px}

/* Header */
.header{display:flex;gap:12px;align-items:center;margin-bottom:14px}
.badge{min-width:44px;height:44px;border-radius:10px;border:2px solid var(--edge);
  display:grid;place-items:center;font-weight:900;color:#cbe0ff;background:#0b1537;}

/* Grid */
.grid{display:grid;gap:12px}
@media(min-width:860px){.grid{grid-template-columns:1.1fr 1fr}}
.panel{margin-top:12px}

/* Input */
label{display:block;margin:8px 6px 6px}
.input{
  width:100%;padding:12px 14px;border-radius:10px;border:2px solid #2a3c7a;background:#0b1537;
  color:var(--ink);font-size:18px;box-shadow:inset 0 0 0 2px #13255a;
}
.input::placeholder{color:#95a6e6}
.btn{
  width:100%;padding:12px 14px;margin-top:10px;cursor:pointer;color:#2a1b00;font-size:18px;font-weight:900;
  background:linear-gradient(#fff2a8,#f0d36e 48%, #e3b94a 49%, #d8ad3e);
  border:3px solid var(--gold3); border-radius:12px; box-shadow:0 4px 0 var(--gold3), 0 10px 26px var(--shadow);
}
.btn:active{transform:translateY(1px); box-shadow:0 3px 0 var(--gold3), 0 8px 18px var(--shadow)}
.err{color:#ff9db2;font-size:14px;display:none;margin-top:4px}

/* Board */
.board{display:grid;gap:12px;margin-top:12px}
@media(min-width:860px){.board{grid-template-columns:360px 1fr}}

/* Profile */
.kv{display:grid;grid-template-columns:auto 1fr;gap:12px;align-items:center}
.avatar{
  width:96px;height:96px;border-radius:12px;border:2px solid var(--edge);
  background:#0b1537;display:grid;place-items:center;font-size:40px;box-shadow:inset 0 0 14px #2b3f8a;
}
.kv dt{color:var(--mut);font-size:12px}
.kv dd{margin:0 0 4px 0;font-size:18px}
.tags{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
.tag{border:2px solid #2b418f;padding:6px 10px;border-radius:999px;font-size:12px;background:#0b1537}

/* Stats */
.stat-row{display:grid;grid-template-columns:110px 1fr 62px;gap:10px;align-items:center;margin:8px 0}
.bar{height:18px;background:var(--bar);border:2px solid #2a3c7a;border-radius:8px;overflow:hidden}
.fill{height:100%;width:0;transition:width .6s}
.pct{text-align:right;font-variant-numeric:tabular-nums}

/* Tabs */
.tabs{display:flex;gap:8px;margin-top:6px}
.tab{flex:1;text-align:center;padding:10px 12px;cursor:pointer;border:2px solid var(--edge);
  border-bottom:0;border-radius:10px 10px 0 0;background:#0b1537;font-weight:700}
.tab.active{background:#13245a}
.tabpan{border:2px solid var(--edge);border-radius:0 10px 10px 10px;padding:12px;background:#0b1537}

/* Six Skills */
.skill{display:grid;grid-template-columns:120px 1fr 52px;gap:10px;align-items:center;margin:8px 0}
.skill-name{color:var(--mut);font-size:13px}

/* Compatibility Ring */
.ring{display:grid;place-items:center;margin-top:8px}
.ring text{font-weight:900}

/* Toast */
.toast{
  position:fixed;left:50%;top:12px;transform:translateX(-50%) translateY(-16px);
  background:#0b1537;border:2px solid var(--edge);border-radius:10px;padding:8px 12px;
  box-shadow:0 10px 26px var(--shadow);z-index:10;opacity:0;transition:.35s;font-weight:800
}
.toast.in{opacity:1;transform:translateX(-50%) translateY(0)}
.foot{color:var(--mut);font-size:12px;text-align:center;margin:16px 0 6px}
.small{color:var(--mut);font-size:12px}
</style>
</head>
<body>
<div id="toast" class="toast" aria-live="polite">ステータスを生成しました。</div>

<div class="wrap">
  <div class="header">
    <div class="badge">OS</div>
    <div>
      <h1>KenGo式：<b>転生ステータス鑑定</b>（王道RPG）</h1>
      <div class="sub">生年月日 → ステータス／6指標％／相性リング　※作成後は自動で結果へ移動（iPhone最適化）</div>
    </div>
  </div>

  <!-- Input -->
  <div class="card grid" id="top">
    <div>
      <div class="sub">▶ あなた</div>
      <label>ニックネーム（任意）</label>
      <input id="nickA" class="input" placeholder="例：KenGo / 勇者（任意）">
      <label>生年月日</label>
      <input id="dateA" class="input" inputmode="numeric" placeholder="19900504 / 1990-05-04 / 1990/05/04">
      <div id="errA" class="err">日付の形式が正しくありません。</div>
      <button id="btnSelf" class="btn">ステータスを生成</button>
      <div class="small" style="margin-top:6px;">* カレンダーUIは使わず自由入力：<code>YYYYMMDD</code> または <code>YYYY-MM-DD</code></div>
    </div>
    <div>
      <div class="sub">▶ 相性（任意）</div>
      <label>相手のニックネーム（任意）</label>
      <input id="nickB" class="input" placeholder="例：僧侶（任意）">
      <label>相手の生年月日（任意）</label>
      <input id="dateB" class="input" inputmode="numeric" placeholder="19940322 / 1994-03-22 など">
      <div id="errB" class="err">日付の形式が正しくありません。</div>
      <button id="btnBoth" class="btn">相性も見る</button>
    </div>
  </div>

  <!-- Result Board -->
  <div id="board" class="board" hidden>
    <!-- LEFT -->
    <div>
      <div class="card" id="statusAnchor">
        <div class="sub">▶ キャラクター</div>
        <div class="kv">
          <div id="avatar" class="avatar">◆</div>
          <div>
            <dl>
              <dt>名前 / Name</dt><dd id="cName">—</dd>
              <dt>クラス（属性）</dt><dd id="cClass">—</dd>
              <dt>称号 / Title</dt><dd id="cTitle">—</dd>
            </dl>
            <div class="tags" id="badges"></div>
          </div>
        </div>
      </div>

      <div class="card panel">
        <div class="sub">▶ 基本ステータス</div>
        <div class="stat-row">
          <div>HP（円の安定）</div>
          <div class="bar"><div id="hpFill" class="fill" style="background:var(--hp)"></div></div>
          <div id="hpPct" class="pct">—%</div>
        </div>
        <div class="stat-row">
          <div>MP（上視点の集中）</div>
          <div class="bar"><div id="mpFill" class="fill" style="background:var(--mp)"></div></div>
          <div id="mpPct" class="pct">—%</div>
        </div>
        <div class="stat-row">
          <div>SP（風の移動）</div>
          <div class="bar"><div id="spFill" class="fill" style="background:var(--sp)"></div></div>
          <div id="spPct" class="pct">—%</div>
        </div>
      </div>
    </div>

    <!-- RIGHT -->
    <div>
      <div class="tabs">
        <div id="tabStatus" class="tab active">ステータス</div>
        <div id="tabCompat" class="tab">相性</div>
      </div>

      <div class="tabpan" id="panStatus">
        <div class="sub">▶ 6指標（%）</div>
        <div id="sixRows"></div>

        <div class="card panel">
          <div class="sub">▶ ヒント</div>
          <div id="hints" class="small">—</div>
        </div>
      </div>

      <div class="tabpan" id="panCompat" style="display:none">
        <div class="sub">▶ 相性リング</div>
        <div class="ring">
          <svg id="ring" width="260" height="260" viewBox="0 0 260 260" aria-label="Compatibility Rings">
            <defs>
              <linearGradient id="gA" x1="0" x2="1"><stop offset="0%" stop-color="#64a7ff"/><stop offset="100%" stop-color="#8bf0a6"/></linearGradient>
              <linearGradient id="gB" x1="0" x2="1"><stop offset="0%" stop-color="#ffd06a"/><stop offset="100%" stop-color="#c7d0ff"/></linearGradient>
            </defs>
            <circle cx="130" cy="130" r="96" stroke="#273d8e" stroke-width="12" fill="none" />
            <circle cx="130" cy="130" r="70" stroke="#273d8e" stroke-width="12" fill="none" />
            <path id="arcA" d="" stroke="url(#gA)" stroke-width="12" fill="none" stroke-linecap="round"/>
            <path id="arcB" d="" stroke="url(#gB)" stroke-width="12" fill="none" stroke-linecap="round"/>
            <text id="ringScore" x="130" y="137" text-anchor="middle" font-size="26" fill="currentColor">--%</text>
          </svg>
        </div>
        <div class="card panel">
          <div class="sub">▶ メモ</div>
          <div id="pairText" class="small">—</div>
        </div>
      </div>
    </div>
  </div>

  <div class="foot">© KenGo System — “風は外輪、中心は円”</div>
</div>

<script>
/* ========= Helper: parse flexible date ========= */
function parseDateInput(v){
  if(!v) return null;
  v = v.trim();
  if(/^\d{8}$/.test(v)){ // YYYYMMDD
    const y = +v.slice(0,4), m = +v.slice(4,6)-1, d = +v.slice(6,8);
    const dt = new Date(Date.UTC(y,m,d));
    return (dt && dt.getUTCFullYear()===y && dt.getUTCMonth()===m && dt.getUTCDate()===d) ? dt : null;
  }
  // YYYY-MM-DD / YYYY/MM/DD
  const vv = v.replace(/\//g,"-");
  if(/^\d{4}-\d{2}-\d{2}$/.test(vv)){
    const [y,m,d] = vv.split("-").map(Number);
    const dt = new Date(Date.UTC(y,m-1,d));
    return (dt && dt.getUTCFullYear()===y && dt.getUTCMonth()===(m-1) && dt.getUTCDate()===d) ? dt : null;
  }
  return null;
}

/* ========= Seed from date (stable, deterministic) ========= */
function seedFromDate(dt){
  // simple LCG seeded by y,m,d to 32-bit
  let s = dt.getUTCFullYear()*10000 + (dt.getUTCMonth()+1)*100 + dt.getUTCDate();
  s = (s ^ 0x9e3779b9) >>> 0;
  const rnd = ()=> (s = Math.imul(1664525, s) + 1013904223 >>> 0) / 2**32;
  return rnd;
}

/* ========= Build 6 indicators (王道・OS寄り) ========= */
const SIX = [
  {key:"circle",  name:"円（安定）"},
  {key:"wind",    name:"風（移動）"},
  {key:"core",    name:"核（復元）"},
  {key:"interval",name:"間（リズム）"},
  {key:"reson",   name:"共振（調和）"},
  {key:"return",  name:"戻り（反転）"},
];

function sixFromDate(dt){
  const rnd = seedFromDate(dt);
  // base distribution with mild bias by weekday/month
  const w = dt.getUTCDay(); // 0..6
  const m = dt.getUTCMonth()+1;
  const b = SIX.map((_,i)=>{
    const base = 0.45 + rnd()*0.35; // 45–80% base
    const tweak = ((i%2===0)?0.04:-0.02) + ((w+i)%3===0?0.03:0) + (m%6===i?0.04:0);
    return Math.max(0, Math.min(1, base + tweak + (rnd()-0.5)*0.08));
  });
  // normalize to keep average around 0.65
  const avg = b.reduce((a,c)=>a+c,0)/b.length;
  const scale = 0.65/avg;
  return b.map(v=>Math.round(Math.max(0, Math.min(1, v*scale))*100));
}

function baseStatsFromSix(arr){
  // map to HP/MP/SP (円/上視点/風)
  const hp = Math.round((arr[0]*0.45 + arr[2]*0.35 + arr[5]*0.20)/1.0);
  const mp = Math.round((arr[3]*0.50 + arr[4]*0.30 + arr[2]*0.20)/1.0);
  const sp = Math.round((arr[1]*0.60 + arr[3]*0.25 + arr[4]*0.15)/1.0);
  return {hp, mp, sp};
}

function classFromProfile(six){
  // calm, neutral naming（王道）
  const c = {
    circle:six[0], wind:six[1], core:six[2],
    interval:six[3], reson:six[4], ret:six[5]
  };
  const pairs = [
    {name:"賢導士（Sage-Navigator）", score: c.interval + c.reson + c.core*0.5},
    {name:"守円士（Circle-Guardian）", score: c.circle + c.core + c.ret},
    {name:"風行士（Wind-Runner）", score: c.wind*1.2 + c.interval},
    {name:"調律士（Resonance-Tuner）", score: c.reson + c.interval + c.ret*0.6},
    {name:"反転士（Return-Master）", score: c.ret*1.2 + c.core*0.6},
  ];
  pairs.sort((a,b)=>b.score-a.score);
  return pairs[0].name;
}

function titleFromSix(six){
  const topIndex = six.reduce((bi,v,i)=> v>six[bi]?i:bi,0);
  const titles = [
    "円環の核", "追い風の歩者", "折れぬ心核", "間合の設計者", "共振の調停者", "帰還の使い"
  ];
  return titles[topIndex];
}

function badgesFromSix(six){
  const tags = [];
  if(six[0]>=70) tags.push("安定域70+");
  if(six[1]>=70) tags.push("移動域70+");
  if(six[2]>=70) tags.push("復元域70+");
  if(six[3]>=70) tags.push("リズム域70+");
  if(six[4]>=70) tags.push("調和域70+");
  if(six[5]>=70) tags.push("反転域70+");
  if(tags.length===0) tags.push("バランス型");
  return tags;
}

function hintsFromProfile(six){
  const lines = [];
  if(six[0] >= 72) lines.push("円の安定が高い。基準点を自分に置くと最強。");
  if(six[1] >= 72) lines.push("動き出しが吉。歩けば風が整うタイプ。");
  if(six[2] >= 72) lines.push("復元力が高い。折れない前提で設計を。");
  if(six[3] >= 72) lines.push("間の取り方が美しい。速度よりタイミング。");
  if(six[4] >= 72) lines.push("場の調和を作れる。2者間の翻訳が得意。");
  if(six[5] >= 72) lines.push("反転上手。痛み→学び→糧の変換が速い。");
  if(lines.length===0) lines.push("まずは“円→風→戻り”を意識。小さく回して精度を上げる。");
  return "・" + lines.join("<br>・");
}

/* ========= Compatibility ========= */
function compatScore(sA, sB){
  // cosine-like similarity on 6-dim + complementarity bonus (circle-wind, core-return)
  const dot = sA.reduce((a,_,i)=>a + sA[i]*sB[i],0);
  const na = Math.sqrt(sA.reduce((a,v)=>a+v*v,0));
  const nb = Math.sqrt(sB.reduce((a,v)=>a+v*v,0));
  const cos = (na && nb) ? dot/(na*nb) : 0;
  const comp = ( (sA[0]+sB[1]) + (sA[2]+sB[5]) ) / 400; // 0..1 ぐらい
  let sc = (cos*0.7 + comp*0.3);
  sc = Math.max(0, Math.min(1, sc));
  return Math.round(sc*100);
}

function setRing(svgId, pct, aRatio=0.62, bRatio=0.55){
  const svg = document.getElementById(svgId) || document;
  const arcA = document.getElementById("arcA");
  const arcB = document.getElementById("arcB");
  const t   = document.getElementById("ringScore");
  const cx=130, cy=130, r1=96, r2=70;
  const toArc = (r, ratio)=>{
    const end = Math.max(0.02, Math.min(0.98, ratio))*Math.PI*2;
    const x = (rr,ang)=> cx + rr*Math.cos(-Math.PI/2 + ang);
    const y = (rr,ang)=> cy + rr*Math.sin(-Math.PI/2 + ang);
    const large = end>Math.PI ? 1 : 0;
    const x1=x(r,0), y1=y(r,0), x2=x(r,end), y2=y(r,end);
    return `M ${x1} ${y1} A ${r} ${r} 0 ${large} 1 ${x2} ${y2}`;
  };
  arcA.setAttribute("d", toArc(r1, Math.min(0.98, pct/100 * aRatio)));
  arcB.setAttribute("d", toArc(r2, Math.min(0.98, pct/100 * bRatio)));
  t.textContent = `${pct}%`;
}

/* ========= UI wiring ========= */
const $ = sel => document.querySelector(sel);
const byId = id => document.getElementById(id);

function showToast(msg){
  const el = byId("toast");
  el.textContent = msg;
  el.classList.add("in");
  setTimeout(()=>el.classList.remove("in"), 1400);
}

function renderSix(container, six){
  container.innerHTML = "";
  SIX.forEach((s,idx)=>{
    const row = document.createElement("div");
    row.className = "skill";
    row.innerHTML = `
      <div class="skill-name">${s.name}</div>
      <div class="bar"><div class="fill" style="width:0;background:${idx%2? 'linear-gradient(90deg,#64a7ff,#8bf0a6)':'linear-gradient(90deg,#ffd06a,#c7d0ff)'}"></div></div>
      <div class="pct">0%</div>`;
    container.appendChild(row);
    requestAnimationFrame(()=>{
      row.querySelector(".fill").style.width = Math.min(100, Math.max(0, six[idx])) + "%";
      row.querySelector(".pct").textContent = `${six[idx]}%`;
    });
  });
}

function fillBars(base){
  byId("hpFill").style.width = base.hp+"%";
  byId("mpFill").style.width = base.mp+"%";
  byId("spFill").style.width = base.sp+"%";
  byId("hpPct").textContent = base.hp+"%";
  byId("mpPct").textContent = base.mp+"%";
  byId("spPct").textContent = base.sp+"%";
}

function scrollToAnchor(){
  byId("board").hidden = false;
  // jump to status
  byId("statusAnchor").scrollIntoView({behavior:"smooth",block:"start"});
}

function makeProfile(name, dt, six){
  const cls = classFromProfile(six);
  const title = titleFromSix(six);
  byId("cName").textContent = name || formatDateName(dt);
  byId("cClass").textContent = cls;
  byId("cTitle").textContent = title;
  const badges = badgesFromSix(six);
  const box = byId("badges");
  box.innerHTML = "";
  badges.forEach(t=>{
    const span = document.createElement("span");
    span.className = "tag"; span.textContent = t; box.appendChild(span);
  });
  // avatar symbol
  byId("avatar").textContent = ["◆","◇","■","▲","△","●"][dt.getUTCMonth()%6];
}

function formatDateName(dt){
  const y=dt.getUTCFullYear(), m=String(dt.getUTCMonth()+1).padStart(2,"0"), d=String(dt.getUTCDate()).padStart(2,"0");
  return `${y}.${m}.${d}`;
}

function onSelf(){
  const dA = parseDateInput(byId("dateA").value);
  byId("errA").style.display = dA? "none":"block";
  if(!dA) return;

  const sixA = sixFromDate(dA);
  const base = baseStatsFromSix(sixA);
  makeProfile(byId("nickA").value, dA, sixA);
  renderSix(byId("sixRows"), sixA);
  fillBars(base);
  byId("hints").innerHTML = hintsFromProfile(sixA);
  // tabs
  setTab("status");
  showToast("ステータスを生成しました。");
  scrollToAnchor();
}

function onBoth(){
  const dA = parseDateInput(byId("dateA").value);
  const dB = parseDateInput(byId("dateB").value);
  byId("errA").style.display = dA? "none":"block";
  byId("errB").style.display = dB? "none":"block";
  if(!dA || !dB) return;

  const sixA = sixFromDate(dA);
  const sixB = sixFromDate(dB);
  const base = baseStatsFromSix(sixA);
  makeProfile(byId("nickA").value, dA, sixA);
  renderSix(byId("sixRows"), sixA);
  fillBars(base);
  byId("hints").innerHTML = hintsFromProfile(sixA);

  const pct = compatScore(sixA, sixB);
  setRing("ring", pct);
  const nameA = byId("nickA").value || formatDateName(dA);
  const nameB = byId("nickB").value || formatDateName(dB);
  byId("pairText").innerHTML = `${nameA} × ${nameB} の相性は <b>${pct}%</b>。<br>
  ・80%以上：歩幅が自然に揃う日。<br>
  ・60–79%：目的共有で一気に加速。<br>
  ・～59%：役割分担と休止の“間”を意識。`;
  setTab("compat");
  showToast("ステータス＋相性を生成しました。");
  scrollToAnchor();
}

/* Tabs */
function setTab(which){
  const tStatus = byId("tabStatus"), tCompat=byId("tabCompat");
  const pStatus = byId("panStatus"), pCompat=byId("panCompat");
  if(which==="status"){ tStatus.classList.add("active"); tCompat.classList.remove("active"); pStatus.style.display="block"; pCompat.style.display="none"; }
  else { tCompat.classList.add("active"); tStatus.classList.remove("active"); pCompat.style.display="block"; pStatus.style.display="none"; }
}

byId("btnSelf").addEventListener("click", onSelf);
byId("btnBoth").addEventListener("click", onBoth);
byId("tabStatus").addEventListener("click", ()=>setTab("status"));
byId("tabCompat").addEventListener("click", ()=>setTab("compat"));
</script>
</body>
</html>